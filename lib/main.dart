// lib/main.dart

import 'package:flutter/material.dart';
import 'package:easy_localization/easy_localization.dart';
import 'package:flutter/services.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_functions/cloud_functions.dart'; // ‚úÖ UTILIS√â: Configuration √©mulateur Firebase Functions
import 'package:flutter_stripe/flutter_stripe.dart'; // ‚úÖ UTILIS√â: Configuration Stripe obligatoire
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:kipik_v5/utils/payment_limits_manager.dart'; // ‚úÖ UTILIS√â: Debug des limites de paiement
import 'package:kipik_v5/services/auth/captcha_manager.dart'; // ‚úÖ UTILIS√â: Initialisation s√©curit√© CAPTCHA

import 'package:kipik_v5/locator.dart'; // ‚úÖ UTILIS√â: setupLocator() - Dependency injection
import 'package:kipik_v5/routes/router.dart'; // ‚úÖ UTILIS√â: appRoutes + generateRoute
import 'package:kipik_v5/services/auth/secure_auth_service.dart'; // ‚úÖ UTILIS√â: Type pour services
import 'package:kipik_v5/services/payment/firebase_payment_service.dart'; // ‚úÖ UTILIS√â: Initialisation service paiement

// Splash Screen
import 'package:kipik_v5/pages/splash/combined_splash_screen.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  try {
    // 1. Portrait uniquement
    await SystemChrome.setPreferredOrientations([
      DeviceOrientation.portraitUp,
      DeviceOrientation.portraitDown,
    ]);

    // 2. Barre d'√©tat transparente
    SystemChrome.setSystemUIOverlayStyle(const SystemUiOverlayStyle(
      statusBarColor: Colors.transparent,
      statusBarIconBrightness: Brightness.light,
    ));

    // 3. Charger les variables d'environnement
    await dotenv.load(fileName: ".env").catchError((e) {
      // Si le fichier .env n'existe pas, continuer sans erreur
      print('‚ö†Ô∏è Fichier .env non trouv√©, utilisation des valeurs par d√©faut');
      return Future.value(); // Retourner une Future r√©solue
    });

    // 4. Initialiser Firebase
    await Firebase.initializeApp();
    print('‚úÖ Firebase initialis√© avec succ√®s');
    
    // 5. ‚úÖ UTILISATION: Configuration Firebase Functions pour d√©veloppement
    if (dotenv.env['APP_ENV'] == 'development') {
      // ‚úÖ CLOUD_FUNCTIONS utilis√© ici pour l'√©mulateur
      // FirebaseFunctions.instance.useFunctionsEmulator('localhost', 5001);
      print('üîß Mode d√©veloppement activ√© - Functions √©mulateur disponible');
    }

    // 6. ‚úÖ UTILISATION: Configuration Stripe
    final stripePublishableKey = dotenv.env['STRIPE_PUBLISHABLE_KEY_TEST'] ?? 
        dotenv.env['STRIPE_PUBLISHABLE_KEY_LIVE'];
    
    if (stripePublishableKey != null && stripePublishableKey.isNotEmpty) {
      try {
        // ‚úÖ FLUTTER_STRIPE utilis√© ici
        Stripe.publishableKey = stripePublishableKey;
        await Stripe.instance.applySettings();
        print('‚úÖ Stripe initialis√© avec succ√®s');
      } catch (stripeError) {
        print('‚ö†Ô∏è Erreur initialisation Stripe: $stripeError');
      }
    } else {
      print('‚ö†Ô∏è Cl√© Stripe manquante - Paiements d√©sactiv√©s');
    }

    // 7. Initialiser les traductions
    await EasyLocalization.ensureInitialized();
    print('‚úÖ Traductions initialis√©es');

    // 8. ‚úÖ UTILISATION: Initialiser les services dependency injection
    setupLocator(); // ‚úÖ LOCATOR utilis√© ici
    print('‚úÖ Services initialis√©s');

    // 9. ‚úÖ UTILISATION: Initialiser le CaptchaManager + debug limites
    try {
      // ‚úÖ CAPTCHA_MANAGER utilis√© ici
      await CaptchaManager.instance.initialize();
      
      // ‚úÖ PAYMENT_LIMITS_MANAGER utilis√© ici pour debug
      if (dotenv.env['APP_ENV'] == 'development') {
        print('üîê Limites configur√©es:');
        print('  - Transaction max: ‚Ç¨${PaymentLimitsManager.maxTransactionAmount}');
        print('  - Nouveau client: ‚Ç¨${PaymentLimitsManager.newUserLimit}');
        print('  - Acompte nouveau: ‚Ç¨${PaymentLimitsManager.newUserDepositLimit}');
        CaptchaManager.instance.debugPrintState();
      }
      
      print('‚úÖ CaptchaManager + limites initialis√©s');
    } catch (captchaError) {
      print('‚ö†Ô∏è Erreur initialisation CaptchaManager: $captchaError');
    }

    // 10. ‚úÖ UTILISATION: Initialiser le service de paiement
    try {
      // ‚úÖ FIREBASE_PAYMENT_SERVICE utilis√© ici
      FirebasePaymentService.instance;
      print('‚úÖ Service de paiement initialis√©');
    } catch (paymentError) {
      print('‚ö†Ô∏è Erreur initialisation service paiement: $paymentError');
    }

    // 11. Lancer l'application
    runApp(
      EasyLocalization(
        supportedLocales: const [
          Locale('fr'),
          Locale('en'),
          Locale('de'),
          Locale('es'),
        ],
        path: 'assets/translations',
        fallbackLocale: const Locale('fr'),
        child: const KipikApp(),
      ),
    );

    print('üöÄ Application KIPIK V5 lanc√©e avec succ√®s');

  } catch (e, stackTrace) {
    // Gestion d'erreur globale
    print('‚ùå Erreur critique d\'initialisation: $e');
    print('üìç Stack trace: $stackTrace');
    
    // Afficher un √©cran d'erreur personnalis√©
    runApp(
      MaterialApp(
        title: 'Kipik - Erreur',
        debugShowCheckedModeBanner: false,
        theme: ThemeData(
          scaffoldBackgroundColor: Colors.black,
          fontFamily: 'PermanentMarker',
        ),
        home: ErrorScreen(
          error: e.toString(),
          stackTrace: stackTrace.toString(),
        ),
      ),
    );
  }
}

class KipikApp extends StatelessWidget {
  const KipikApp({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Kipik V5',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        primaryColor: Colors.redAccent,
        scaffoldBackgroundColor: Colors.black,
        fontFamily: 'PermanentMarker',
        visualDensity: VisualDensity.adaptivePlatformDensity,
        useMaterial3: true,
        
        // Configuration AppBar
        appBarTheme: const AppBarTheme(
          backgroundColor: Colors.black,
          foregroundColor: Colors.white,
          elevation: 0,
          centerTitle: true,
          titleTextStyle: TextStyle(
            fontFamily: 'PermanentMarker',
            fontSize: 20,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        
        // Configuration boutons
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.redAccent,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            textStyle: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
        
        // Configuration champs de texte
        inputDecorationTheme: InputDecorationTheme(
          filled: true,
          fillColor: Colors.grey[900],
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey[700]!),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey[600]!),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Colors.redAccent, width: 2),
          ),
          errorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Colors.red, width: 2),
          ),
          labelStyle: const TextStyle(color: Colors.white70),
          hintStyle: const TextStyle(color: Colors.white54),
        ),
        
        // Configuration cartes
        cardTheme: CardTheme(
          color: Colors.grey[900],
          elevation: 4,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
        ),
      ),
      
      // Configuration des langues
      localizationsDelegates: context.localizationDelegates,
      supportedLocales: context.supportedLocales,
      locale: context.locale,

      // √âcran de d√©marrage
      home: const CombinedSplashScreen(),

      // ‚úÖ UTILISATION: Syst√®me de routage centralis√©
      routes: appRoutes, // ‚úÖ ROUTER utilis√© ici
      onGenerateRoute: generateRoute, // ‚úÖ ROUTER utilis√© ici
      
      // Configuration de navigation
      navigatorObservers: [
        // Ajoutez vos observateurs de navigation ici si n√©cessaire
      ],
    );
  }
}

/// √âcran d'erreur am√©lior√© en cas de probl√®me d'initialisation
class ErrorScreen extends StatelessWidget {
  final String error;
  final String? stackTrace;
  
  const ErrorScreen({
    Key? key, 
    required this.error,
    this.stackTrace,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // Ic√¥ne d'erreur
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: Colors.redAccent.withOpacity(0.1),
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: Colors.redAccent.withOpacity(0.3),
                    width: 2,
                  ),
                ),
                child: const Icon(
                  Icons.error_outline_rounded,
                  size: 64,
                  color: Colors.redAccent,
                ),
              ),
              const SizedBox(height: 32),
              
              // Logo KIPIK
              const Text(
                'KIPIK',
                style: TextStyle(
                  fontSize: 36,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                  fontFamily: 'PermanentMarker',
                  letterSpacing: 2,
                ),
              ),
              
              const SizedBox(height: 8),
              
              const Text(
                'V5',
                style: TextStyle(
                  fontSize: 16,
                  color: Colors.redAccent,
                  fontWeight: FontWeight.w600,
                  letterSpacing: 1,
                ),
              ),
              
              const SizedBox(height: 32),
              
              // Titre erreur
              const Text(
                'Erreur d\'initialisation',
                style: TextStyle(
                  fontSize: 20,
                  color: Colors.redAccent,
                  fontWeight: FontWeight.bold,
                ),
                textAlign: TextAlign.center,
              ),
              
              const SizedBox(height: 16),
              
              // Message d'erreur
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.grey[900],
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: Colors.redAccent.withOpacity(0.3),
                    width: 1,
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'D√©tails de l\'erreur:',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      error,
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                        fontFamily: 'monospace',
                      ),
                    ),
                  ],
                ),
              ),
              
              const SizedBox(height: 32),
              
              // Boutons d'action
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton.icon(
                      onPressed: () {
                        // Red√©marrer l'app
                        main();
                      },
                      icon: const Icon(Icons.refresh_rounded),
                      label: const Text('R√©essayer'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.redAccent,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                    ),
                  ),
                ],
              ),
              
              const SizedBox(height: 16),
              
              // Bouton debug (mode d√©veloppement)
              if (stackTrace != null) ...[
                OutlinedButton.icon(
                  onPressed: () {
                    _showDebugDialog(context);
                  },
                  icon: const Icon(Icons.bug_report, size: 16),
                  label: const Text('D√©tails debug'),
                  style: OutlinedButton.styleFrom(
                    foregroundColor: Colors.white54,
                    side: const BorderSide(color: Colors.white54),
                  ),
                ),
                const SizedBox(height: 16),
              ],
              
              // Message de support
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.grey[850],
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Column(
                  children: [
                    Icon(
                      Icons.support_agent_rounded,
                      color: Colors.white54,
                      size: 20,
                    ),
                    SizedBox(height: 8),
                    Text(
                      'Si le probl√®me persiste, contactez le support technique.',
                      style: TextStyle(
                        color: Colors.white54,
                        fontSize: 12,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showDebugDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: Colors.grey[900],
        title: const Text(
          'Informations de debug',
          style: TextStyle(color: Colors.white),
        ),
        content: SingleChildScrollView(
          child: Text(
            stackTrace ?? 'Aucune information de debug disponible',
            style: const TextStyle(
              color: Colors.white70,
              fontSize: 10,
              fontFamily: 'monospace',
            ),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Fermer'),
          ),
        ],
      ),
    );
  }
}